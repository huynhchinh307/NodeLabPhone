<UserControl x:Class="NodeLabFarm.Controls.ScriptEditor.ScriptWorkflow"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:ui="http://schemas.lepo.co/wpfui/2022/xaml"
             xmlns:models="clr-namespace:NodeLabFarm.Models"
             mc:Ignorable="d" d:DesignHeight="600" d:DesignWidth="700">
    
    <Grid Background="#0d0e12">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/> <!-- Header -->
            <RowDefinition Height="*"/>    <!-- Flow -->
        </Grid.RowDefinitions>

        <!-- Script Header Info -->
        <Border Grid.Row="0" BorderBrush="#2d2f39" BorderThickness="0,0,0,1" Padding="24,16">
            <StackPanel>
                <TextBlock Text="Thiết lập kịch bản" FontSize="14" Foreground="#9ca3af" Margin="0,0,0,8"/>
                <Grid>
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="Auto"/>
                    </Grid.RowDefinitions>
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="*"/>
                        <ColumnDefinition Width="Auto"/>
                    </Grid.ColumnDefinitions>
                    
                    <!-- Name Input -->
                    <StackPanel Grid.Column="0" Margin="0,0,16,0">
                         <TextBlock Text="Tên kịch bản" FontSize="12" Foreground="#6b7280" Margin="0,0,0,4"/>
                         <ui:TextBox Text="{Binding CurrentScript.Name, UpdateSourceTrigger=PropertyChanged}" FontSize="16" FontWeight="SemiBold" PlaceholderText="Nhập tên kịch bản..."/>
                    </StackPanel>

                    <!-- Row 2: Controls -->
                    <StackPanel Grid.Row="1" Grid.Column="0" Grid.ColumnSpan="2" Orientation="Horizontal" Margin="0,16,0,0" VerticalAlignment="Center">
                        <!-- Device Select -->
                        <StackPanel Margin="0,0,16,0">
                            <TextBlock Text="Thiết bị (Online)" FontSize="11" Foreground="#6b7280" Margin="0,0,0,4"/>
                            <ComboBox ItemsSource="{Binding OnlineDevices}" 
                                      SelectedItem="{Binding SelectedTestDevice}"
                                      Width="240" Height="36"
                                      Background="#1a1c23" Foreground="White" BorderBrush="#3f424e">
                                <ComboBox.ItemTemplate>
                                    <DataTemplate>
                                        <StackPanel Orientation="Horizontal">
                                            <ui:SymbolIcon Symbol="Phone24" FontSize="12" Margin="0,0,8,0" Foreground="#22c55e"/>
                                            <TextBlock Text="{Binding Name}" VerticalAlignment="Center"/>
                                        </StackPanel>
                                    </DataTemplate>
                                </ComboBox.ItemTemplate>
                            </ComboBox>
                        </StackPanel>

                        <!-- Run/Stop Buttons -->
                        <StackPanel Orientation="Horizontal" VerticalAlignment="Bottom">
                            <ui:Button Command="{Binding RunScriptCommand}" 
                                       Appearance="Primary" Height="36" Width="48" Margin="0,0,8,0"
                                       ToolTip="Chạy kịch bản">
                                <ui:SymbolIcon Symbol="Play24"/>
                            </ui:Button>

                            <ui:Button Command="{Binding ViewDeviceCommand}"
                                       Appearance="Secondary" Height="36" Width="48" Margin="0,0,8,0"
                                       ToolTip="Xem màn hình thiết bị">
                                <ui:SymbolIcon Symbol="Desktop24" Foreground="#60a5fa"/>
                            </ui:Button>
                            
                            <ui:Button Command="{Binding StopScriptCommand}"
                                       Appearance="Secondary" Height="36" Width="48" Foreground="#ef4444"
                                       ToolTip="Dừng kịch bản">
                                <ui:SymbolIcon Symbol="Stop24"/>
                            </ui:Button>
                        </StackPanel>

                        <ui:Button Command="{Binding SaveScriptCommand}" Appearance="Primary" Icon="Save24" Content="Lưu kịch bản" Height="36" Margin="16,0,0,0" VerticalAlignment="Bottom"/>
                    </StackPanel>

                    <!-- Version Input -->
                    <StackPanel Grid.Column="1" Width="120">
                         <TextBlock Text="Phiên bản" FontSize="12" Foreground="#6b7280" Margin="0,0,0,4"/>
                         <ui:TextBox Text="{Binding CurrentScript.Version, UpdateSourceTrigger=PropertyChanged}" FontSize="16" PlaceholderText="v1.0.0"/>
                    </StackPanel>
                </Grid>
            </StackPanel>
        </Border>

        <!-- Steps List (Visual Flow) -->
        <ScrollViewer Grid.Row="1" VerticalScrollBarVisibility="Auto" Padding="24">
            <ItemsControl ItemsSource="{Binding CurrentScript.Steps}">
                <ItemsControl.ItemTemplate>
                    <DataTemplate DataType="{x:Type models:ScriptStepModel}">
                        <Border Margin="0,0,0,24" Background="Transparent">
                            <StackPanel HorizontalAlignment="Center">
                                
                                <!-- Connection Line (Above) -->
                                
                                <ui:Card Padding="0" Width="400" Background="#21232b" BorderBrush="{Binding RelativeSource={RelativeSource Self}, Path=IsMouseOver, Converter={x:Null}}">
                                    <ui:Card.Style>
                                        <Style TargetType="ui:Card" BasedOn="{StaticResource {x:Type ui:Card}}">
                                            <Setter Property="BorderBrush" Value="#3f424e"/>
                                            <Setter Property="BorderThickness" Value="1"/>
                                            <Style.Triggers>
                                                <Trigger Property="IsMouseOver" Value="True">
                                                    <Setter Property="BorderBrush" Value="#60a5fa"/>
                                                    <Setter Property="Cursor" Value="Hand"/>
                                                </Trigger>
                                            </Style.Triggers>
                                        </Style>
                                    </ui:Card.Style>
                                    
                                    <Button Command="{Binding DataContext.SelectStepCommand, RelativeSource={RelativeSource AncestorType=UserControl}}" 
                                            CommandParameter="{Binding}"
                                            Padding="0" Background="Transparent" BorderThickness="0" HorizontalContentAlignment="Stretch" VerticalContentAlignment="Stretch">
                                        <Button.Template>
                                            <ControlTemplate TargetType="Button">
                                                <ContentPresenter/>
                                            </ControlTemplate>
                                        </Button.Template>
                                        
                                        <Grid>
                                            <Grid.ColumnDefinitions>
                                                <ColumnDefinition Width="Auto"/> <!-- Status/Icon Color Strip -->
                                                <ColumnDefinition Width="*"/>
                                                <ColumnDefinition Width="Auto"/> <!-- Actions -->
                                            </Grid.ColumnDefinitions>
                                            
                                            <Border Grid.Column="0" Width="6" Background="#3b82f6" CornerRadius="4,0,0,4" HorizontalAlignment="Left"/>
                                            
                                            <StackPanel Grid.Column="1" Margin="16,12">
                                                <StackPanel Orientation="Horizontal" Margin="0,0,0,4">
                                                    <ui:SymbolIcon Symbol="{Binding Icon}" FontSize="16" Foreground="#9ca3af" Margin="0,0,8,0"/>
                                                    <TextBlock Text="{Binding DisplayName}" FontWeight="SemiBold" Foreground="White"/>
                                                </StackPanel>
                                                <StackPanel Orientation="Horizontal">
                                                    <TextBlock Text="Delay:" FontSize="11" Foreground="#6b7280" Margin="0,0,4,0"/>
                                                    <TextBlock Text="{Binding Delay}" FontSize="11" Foreground="#9ca3af"/>
                                                </StackPanel>
                                            </StackPanel>

                                            <StackPanel Grid.Column="2" Orientation="Horizontal" Margin="0,0,8,0">
                                                 <!-- Run Step Button -->
                                                 <ui:Button Appearance="Transparent" Foreground="#34d399" 
                                                            Command="{Binding DataContext.RunStepCommand, RelativeSource={RelativeSource AncestorType=UserControl}}" 
                                                            CommandParameter="{Binding}"
                                                            ToolTip="Chạy thử lệnh này">
                                                     <ui:SymbolIcon Symbol="PlayCircle24"/>
                                                 </ui:Button>

                                                 <ui:Button Appearance="Transparent" Foreground="#ef4444" 
                                                            Command="{Binding DataContext.RemoveStepCommand, RelativeSource={RelativeSource AncestorType=UserControl}}" 
                                                            CommandParameter="{Binding}"
                                                            ToolTip="Xóa lệnh">
                                                     <ui:SymbolIcon Symbol="Delete24"/>
                                                 </ui:Button>
                                            </StackPanel>
                                        </Grid>
                                    </Button>
                                </ui:Card>

                                <!-- Connection Line (Below) -->
                                <Rectangle Width="2" Height="16" Fill="#2d2f39" Margin="0,0,0,0"/>
                                <ui:SymbolIcon Symbol="ChevronDown24" Foreground="#2d2f39" FontSize="16"/>

                            </StackPanel>
                        </Border>
                    </DataTemplate>
                </ItemsControl.ItemTemplate>
            </ItemsControl>
        </ScrollViewer>
    </Grid>
</UserControl>
